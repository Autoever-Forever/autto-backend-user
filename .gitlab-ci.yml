image: docker:latest

variables:
  DOCKER_IMAGE: "userservice-image:latest"
  REGISTRY_URL: "docker.io"
  DOCKERHUB_REPO: "auttto/autto-userservice"
  DOCKERHUB_USERNAME: "auttto"
  GITLAB_REPO: "backend-user"  # GitLab ë ˆí¬ì§€í† ë¦¬ URL
  GITLAB_TOKEN: "$CI_JOB_TOKEN"  # GitLab CI í™˜ê²½ ë³€ìˆ˜ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë˜ëŠ” í† í°
  # GITLAB_URL  # GitLab ì£¼ì†Œ - secret variable ì— ì •ì˜
  # DOCKERHUB_PASSWORD # DOCKERHUB ë¹„ë°€ë²ˆí˜¸ - secret variable ì— ì •ì˜

# main ë¸Œëœì¹˜ì—ì„œë§Œ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

stages:
  - checkout
  - build
  - push

checkout:
  stage: checkout
  script:
    - echo "Cloning repository from GitLab..."
    - git clone http://gitlab-ci-token:${GITLAB_TOKEN}@${GITLAB_URL}/${GITLAB_REPO}.git # GitLab í† í°ìœ¼ë¡œ ì¸ì¦
    - cd $GITLAB_REPO

image_build:
  stage: build
  script:
    - echo "Building Docker image..."
    - docker build -t $DOCKER_IMAGE .

image_push:
  stage: push
  script:
    # ê°€ì¥ ìµœê·¼ íƒœê·¸ë¥¼ ê°€ì ¸ì˜¤ê¸°
    - git fetch --tags
    - LAST_TAG=$(git describe --tags --abbrev=0)
    
    # íƒœê·¸ê°€ ì—†ë‹¤ë©´ ê¸°ë³¸ v0.0.0 íƒœê·¸ ë¶€ì—¬
    - if [ -z "$LAST_TAG" ]; then LAST_TAG="v0.1.0"; fi
    
    # ì´ë¯¸ì§€ íƒœê·¸ ë¶€ì—¬
    - IMAGE_TAG=${DOCKERHUB_REPO}:${LAST_TAG}
    
    # ì‚¬ì „ í™•ì¸
    - docker images  # í˜„ì¬ ì¡´ì¬í•˜ëŠ” ì´ë¯¸ì§€ ëª©ë¡ ì¶œë ¥
    - echo "ğŸ” Using Git tag for Docker image: ${LAST_TAG}"

    # Docker ë¡œê·¸ì¸
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    # íƒœê¹… ë° í‘¸ì‹œ
    - docker tag $DOCKER_IMAGE $IMAGE_TAG
    - docker push $IMAGE_TAG