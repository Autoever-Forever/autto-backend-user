image: ubuntu:latest

variables:
  DOCKER_IMAGE: "userservice-image:latest"
  REGISTRY_URL: "docker.io"
  DOCKERHUB_REPO: "auttto/autto-userservice"
  DOCKERHUB_USERNAME: "auttto"
  GITLAB_REPO: "backend-user"  # GitLab 레포지토리 URL
  GITLAB_TOKEN: "$CI_JOB_TOKEN"  # GitLab CI 환경 변수에서 자동으로 제공되는 토큰
  # GITLAB_URL  # GitLab 주소 - secret variable 에 정의
  # DOCKERHUB_PASSWORD # DOCKERHUB 비밀번호 - secret variable 에 정의

# main 브랜치에서만 파이프라인 실행
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

stages:
  - build # 이미지 빌드
  - push # 이미지 도커 허브에 푸쉬

image_build:
  stage: build
  script:
    - echo "Building Docker image..."
    - docker build -t $DOCKER_IMAGE .

image_push:
  stage: push
  script:
    # 가장 최근 태그를 가져오기
    - git fetch --tags
    - VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0.${CI_PIPELINE_ID}") # 태그가 없다면 기본 v0.0.0.{파이프라인 실행 ID} 태그 부여

    # 이미지 태그 부여
    - IMAGE_TAG=${DOCKERHUB_REPO}:${VERSION_TAG}

    # 사전 확인
    - docker images  # 현재 존재하는 이미지 목록 출력
    - echo "----------------- 이미지 태그 -----------------"
    - echo "🔍 Using Image tag:${IMAGE_TAG}"

    # Docker 로그인
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    # 태깅 및 푸시
    - docker tag $DOCKER_IMAGE $IMAGE_TAG
    - docker push $IMAGE_TAG